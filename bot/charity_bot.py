import logging
import os
import re
from dotenv import load_dotenv
from telegram import (ReplyKeyboardRemove,
                      Update,
                      InlineKeyboardMarkup,
                      InlineKeyboardButton,
                      ParseMode)
from telegram.ext import (Updater,
                          CommandHandler,
                          ConversationHandler,
                          CallbackContext,
                          CallbackQueryHandler)

from bot.states import (GREETING,
                        CATEGORY,
                        AFTER_CATEGORY_REPLY,
                        MENU,
                        OPEN_TASKS,
                        NO_CATEGORY,
                        AFTER_ADD_CATEGORY,
                        AFTER_NEW_QUESTION,
                        AFTER_ADD_FEATURE,
                        TYPING,
                        START_OVER,
                        START_SHOW_TASK,
                        CANCEL_FEEDBACK)

from bot.data_to_db import (add_user,
                            change_subscription,
                            get_tasks,
                            get_category,
                            change_user_category,
                            log_command)
from bot.formatter import display_task
from bot.constants import LOG_COMMANDS_NAME

PAGINATION = 3

load_dotenv()

logger = logging.getLogger(__name__)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)

updater = Updater(token=os.getenv('TOKEN'))

menu_buttons = [
    [
        InlineKeyboardButton(
            text='üîé –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task'
        )
    ],
    [
        InlineKeyboardButton(
            text='‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏', callback_data='change_category'
        )
    ],
    [
        InlineKeyboardButton(
            text='‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/–æ—à–∏–±–∫—É', callback_data='new_feature'
        )
    ],
    [
        InlineKeyboardButton(
            text='‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å', callback_data='ask_question'
        )
    ],
    [
        InlineKeyboardButton(
            text='‚ÑπÔ∏è –û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ', callback_data='about'
        )
    ],
    [
        InlineKeyboardButton(
            text='‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–≤–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∑–∞–¥–∞–Ω–∏—è',
            callback_data='stop_subscription'
        )
    ]
]


@log_command(command=LOG_COMMANDS_NAME['start'], start_menu=True)
def start(update: Update, context: CallbackContext) -> int:
    add_user(update.message)

    button = [
        [
            InlineKeyboardButton(text='–ü–æ–µ—Ö–∞–ª–∏!', callback_data=GREETING)
        ]
    ]
    keyboard = InlineKeyboardMarkup(button)
    update.message.reply_text(
        '–ü—Ä–∏–≤–µ—Ç! üëã \n'
        '–Ø –±–æ—Ç ProCharity -–æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–∞.'
        '–ë—É–¥—É –¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –≤ –∫—É—Ä—Å–µ –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∏ –ø–æ–º–æ–≥—É –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è '
        '—Å –∫–æ–º–∞–Ω–¥–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.\n\n'
        '–ù–∞—á–Ω—ë–º?',
        reply_markup=keyboard
    )

    context.user_data[START_OVER] = False

    return GREETING


@log_command(command=LOG_COMMANDS_NAME['change_user_categories'])
def change_user_categories(update: Update, context: CallbackContext):
    """Auxiliary function for selecting a category and changing the status of subscriptions."""
    pattern_id = re.findall(r'\d+', update.callback_query.data)
    category_id = int(pattern_id[0])
    telegram_id = update.effective_user.id

    change_user_category(telegram_id=telegram_id, category_id=category_id)
    update.callback_query.answer()
    choose_category(update, context)


@log_command(command=LOG_COMMANDS_NAME['choose_category'], ignore_func='change_user_categories')
def choose_category(update: Update, context: CallbackContext):
    """The main function is to select categories for subscribing to them."""

    categories = get_category(update.effective_user.id)

    buttons = []
    for cat in categories:
        if cat['user_selected']:
            cat['name'] += " ‚úÖ"
        buttons.append([InlineKeyboardButton(text=cat['name'], callback_data=f'up_cat{cat["category_id"]}'
                                             )])

    buttons += [
        [
            InlineKeyboardButton(text='–ù–µ—Ç –º–æ–∏—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π üòï',
                                 callback_data='no_relevant')
        ],
        [
            InlineKeyboardButton(text='–ì–æ—Ç–æ–≤–æ üëå', callback_data='ready'),
        ],
    ]
    keyboard = InlineKeyboardMarkup(buttons)

    update.callback_query.edit_message_text(
        text='–ß—Ç–æ–±—ã —è –∑–Ω–∞–ª, —Å –∫–∞–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å, '
             '–≤—ã–±–µ—Ä–∏ —Å–≤–æ–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å '
             '–Ω–µ—Å–∫–æ–ª—å–∫–æ). –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ, –Ω–∞–∂–º–∏ –Ω–∞ –ø—É–Ω–∫—Ç "–ì–æ—Ç–æ–≤–æ üëå"',
        reply_markup=keyboard,
    )
    return CATEGORY


@log_command(command=LOG_COMMANDS_NAME['after_category_choose'])
def after_category_choose(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task')
        ],
        [
            InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)
    update.callback_query.edit_message_text(
        text='–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ç–µ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö '
             '–∑–∞–¥–∞–Ω–∏—è—Ö –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö: <–ø–µ—Ä–µ—á–µ–Ω—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π>.\n\n'
             '–ê –ø–æ–∫–∞ –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è.',
        reply_markup=keyboard
    )
    return AFTER_CATEGORY_REPLY


@log_command(command=LOG_COMMANDS_NAME['open_menu'])
def open_menu(update: Update, context: CallbackContext):
    keyboard = InlineKeyboardMarkup(menu_buttons)
    text = '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é'
    update.callback_query.answer()
    update.callback_query.edit_message_text(text=text, reply_markup=keyboard)

    return MENU


@log_command(command=LOG_COMMANDS_NAME['show_open_task'])
def show_open_task(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ—â—ë', callback_data='open_task')
        ],
        [
            InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)

    showed = 0
    show_task_now = []

    if not context.user_data.get(START_SHOW_TASK):
        context.user_data[START_SHOW_TASK] = []

    tasks = get_tasks(update.effective_user.id)
    if tasks:
        tasks.sort(key=lambda x: x[0].id)
        for task in tasks:
            if task[0].id not in context.user_data[START_SHOW_TASK] and showed != PAGINATION:
                context.user_data[START_SHOW_TASK].append(task[0].id)
                show_task_now.append(task)
                showed += 1

    if not show_task_now:
        update.callback_query.edit_message_text(
            text='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π',
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')]]
            )
        )
    elif len(show_task_now) == 1:
        context.bot.send_message(
            chat_id=update.effective_chat.id, text=display_task(show_task_now[0]), parse_mode=ParseMode.HTML
        )
        update.callback_query.delete_message()

        context.bot.send_message(
            chat_id=update.effective_chat.id,
            text='–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π',
            reply_markup=InlineKeyboardMarkup(
                [[InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')]]
            )
        )
    else:
        for task in show_task_now[:PAGINATION]:
            context.bot.send_message(
                chat_id=update.effective_chat.id, text=display_task(task), parse_mode=ParseMode.HTML
            )

        update.callback_query.delete_message()

        context.bot.send_message(
            chat_id=update.effective_chat.id, text='–ï—Å—Ç—å –µ—â—ë –∑–∞–¥–∞–Ω–∏—è, –ø–æ–∫–∞–∑–∞—Ç—å?', parse_mode=ParseMode.MARKDOWN,
            reply_markup=keyboard
        )

    return OPEN_TASKS


@log_command(command=LOG_COMMANDS_NAME['send_task_to_friend'])
def send_task_to_friend(update: Update, context: CallbackContext):
    pass


@log_command(command=LOG_COMMANDS_NAME['ask_question'])
def ask_question(update: Update, context: CallbackContext):
    button = [
        [InlineKeyboardButton(text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu')]
    ]
    keyboard = InlineKeyboardMarkup(button)
    update.callback_query.edit_message_text(
        text='–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å', reply_markup=keyboard
    )

    return AFTER_NEW_QUESTION


@log_command(command=LOG_COMMANDS_NAME['after_ask_question'])
def after_ask_question(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task')
        ],
        [
            InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)
    update.callback_query.answer()
    update.callback_query.edit_message_text(
        text='–°–ø–∞—Å–∏–±–æ, —è —É–∂–µ –ø–µ—Ä–µ–¥–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ–ª–ª–µ–≥–∞–º! '
             '–û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –Ω–∞ —Ç–≤–æ—é –ø–æ—á—Ç—É <–ø–æ—á—Ç–∞ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞>',
        reply_markup=keyboard
    )

    return AFTER_CATEGORY_REPLY


@log_command(command=LOG_COMMANDS_NAME['no_relevant_category'])
def no_relevant_category(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(
                text='–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏', callback_data='add_new_category'
            )
        ],
        [
            InlineKeyboardButton(
                text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task'
            )
        ],
        [
            InlineKeyboardButton(
                text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu'
            )
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)
    update.callback_query.edit_message_text(
        text='–†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –Ω–∞–º —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å? '
             '–¢–∞–∫–∂–µ —Ç—ã –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö üòâ',
        reply_markup=keyboard
    )

    return NO_CATEGORY


@log_command(command=LOG_COMMANDS_NAME['email_feedback'])
def email_feedback(update: Update, context: CallbackContext):
    button = [
        [
            InlineKeyboardButton(text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(button)
    update.callback_query.edit_message_text(
        text='–ë—É–¥–µ–º —Ä–∞–¥—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ '
             '–ø–æ—á—Ç–µ procharity@friends-foundation.com',
        reply_markup=keyboard
    )

    return MENU


@log_command(command=LOG_COMMANDS_NAME['add_new_category'])
def add_new_category(update: Update, context: CallbackContext):
    button = [
        [InlineKeyboardButton(text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu')]
    ]
    keyboard = InlineKeyboardMarkup(button)
    update.callback_query.edit_message_text(
        text='–ù–∞–ø–∏—à–∏, –≤ –∫–∞–∫–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ —Ç—ã –±—ã —Ö–æ—Ç–µ–ª –ø–æ–º–æ–≥–∞—Ç—å?',
        reply_markup=keyboard
    )

    return AFTER_ADD_CATEGORY


@log_command(command=LOG_COMMANDS_NAME['after_add_new_category'])
def after_add_new_category(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task')
        ],
        [
            InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)
    update.callback_query.edit_message_text(
        text='–°–ø–∞—Å–∏–±–æ, —è –ø–µ—Ä–µ–¥–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–µ ProCharity!'
             '–û—Ç–≤–µ—Ç –ø—Ä–∏–¥–µ—Ç –Ω–∞ –ø–æ—á—Ç—É <email –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞>',
        reply_markup=keyboard
    )

    return AFTER_ADD_CATEGORY


@log_command(command=LOG_COMMANDS_NAME['add_new_feature'])
def add_new_feature(update: Update, context: CallbackContext):
    update.callback_query.answer()
    update.callback_query.edit_message_text(
        text='–†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ç–µ–±–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç?'
    )

    return TYPING


@log_command(command=LOG_COMMANDS_NAME['after_add_new_feature'])
def after_add_new_feature(update: Update, context: CallbackContext):
    buttons = [
        [
            InlineKeyboardButton(text='–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è', callback_data='open_task')
        ],
        [
            InlineKeyboardButton(text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu')
        ]
    ]
    keyboard = InlineKeyboardMarkup(buttons)
    update.callback_query.edit_message_text(
        text='–°–ø–∞—Å–∏–±–æ, —è —É–∂–µ –ø–µ—Ä–µ–¥–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ–ª–ª–µ–≥–∞–º! '
             '–û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç –Ω–∞ —Ç–≤–æ—é –ø–æ—á—Ç—É <–ø–æ—á—Ç–∞ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞>',
        reply_markup=keyboard
    )

    return AFTER_ADD_FEATURE


@log_command(command=LOG_COMMANDS_NAME['about'])
def about(update: Update, context: CallbackContext):
    button = [
        [InlineKeyboardButton(text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu')]
    ]
    keyboard = InlineKeyboardMarkup(button)
    update.callback_query.edit_message_text(
        text='–° ProCharity –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–º '
             '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –∏ '
             '–æ–ø—ã—Ç–∞. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –≤–æ–ª–æ–Ω—Ç—ë—Ä –±–µ–∑–≤–æ–∑–º–µ–∑–¥–Ω–æ –¥–∞—Ä–∏—Ç —Ñ–æ–Ω–¥—É —Å–≤–æ—ë '
             '–≤—Ä–µ–º—è –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, –ø–æ–∑–≤–æ–ª—è—è —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏, '
             '–∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä—É–¥–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–∏–ª–∞–º–∏ —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.',
        reply_markup=keyboard
    )

    return MENU


@log_command(command=LOG_COMMANDS_NAME['stop_task_subscription'])
def stop_task_subscription(update: Update, context: CallbackContext):
    new_mailing_status = change_subscription(update.effective_user.id)
    cancel_feedback_buttons = [
        [
            InlineKeyboardButton(
                text='–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',
                callback_data='many_notification'
            )
        ],
        [
            InlineKeyboardButton(
                text='–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–æ',
                callback_data='no_time'
            )
        ],
        [
            InlineKeyboardButton(
                text='–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π',
                callback_data='no_relevant_task'
            )
        ],
        [
            InlineKeyboardButton(
                text='–ë–æ—Ç –º–Ω–µ –Ω–µ —É–¥–æ–±–µ–Ω',
                callback_data='bot_is_bad'
            )
        ],
        [
            InlineKeyboardButton(
                text='–§–æ–Ω–¥—ã –º–µ–Ω—è –Ω–µ –≤—ã–±–∏—Ä–∞—é—Ç',
                callback_data='fond_ignore'
            )
        ],
        [
            InlineKeyboardButton(text='–î—Ä—É–≥–æ–µ', callback_data='another')
        ],
    ]
    cancel_feedback_keyboard = InlineKeyboardMarkup(cancel_feedback_buttons)

    button = [
        [
            InlineKeyboardButton(
                text='–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é', callback_data='open_menu'
            )
        ],
        [
            InlineKeyboardButton(
                text='–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é', callback_data='open_menu'
            )
        ]
    ]
    keyboard = InlineKeyboardMarkup(button)

    if new_mailing_status:
        answer = '–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ç–µ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö ' \
                 '–∑–∞–¥–∞–Ω–∏—è—Ö –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö: <–ø–µ—Ä–µ—á–µ–Ω—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π>.\n\n' \
                 '–ê –ø–æ–∫–∞ –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è.'

        update.callback_query.edit_message_text(text=answer,
                                                reply_markup=keyboard
                                                )

        return AFTER_CATEGORY_REPLY

    else:
        answer = '–¢—ã –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—à—å –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –æ—Ç —Ñ–æ–Ω–¥–æ–≤, –Ω–æ ' \
                 '–≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ –∏—Ö –Ω–∞ —Å–∞–π—Ç–µ https://procharity.ru'

        update.callback_query.edit_message_text(
            text=answer, reply_markup=cancel_feedback_keyboard
        )

    return CANCEL_FEEDBACK


def cancel_feedback(update: Update, context: CallbackContext):
    keyboard = InlineKeyboardMarkup(menu_buttons)
    update.callback_query.edit_message_text(
        text='–°–ø–∞—Å–∏–±–æ, —è –ø–µ—Ä–µ–¥–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–µ ProCharity!',
        reply_markup=keyboard
    )

    return MENU


@log_command(command=LOG_COMMANDS_NAME['cancel'])
def cancel(update: Update, context: CallbackContext):
    user = update.message.from_user
    logger.info("User %s canceled the conversation.", user.first_name)
    update.message.reply_text(
        'Bye! I hope we can talk again some day.',
        reply_markup=ReplyKeyboardRemove()
    )

    return ConversationHandler.END


def main() -> None:
    dispatcher = updater.dispatcher

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            GREETING: [
                CallbackQueryHandler(choose_category, pattern='^' + GREETING + '$')
            ],
            CATEGORY: [
                CallbackQueryHandler(choose_category, pattern='^return_chose_category$'),
                CallbackQueryHandler(after_category_choose, pattern='^ready$'),
                CallbackQueryHandler(no_relevant_category, pattern='^no_relevant$')

            ],
            AFTER_CATEGORY_REPLY: [
                CallbackQueryHandler(show_open_task, pattern='^open_task$'),
                CallbackQueryHandler(open_menu, pattern='^open_menu$')
            ],
            MENU: [
                CallbackQueryHandler(show_open_task, pattern='^open_task$'),
                CallbackQueryHandler(email_feedback, pattern='^ask_question$'),
                CallbackQueryHandler(about, pattern='^about$'),
                CallbackQueryHandler(choose_category, pattern='^change_category$'),
                CallbackQueryHandler(email_feedback, pattern='^new_feature$'),
                CallbackQueryHandler(stop_task_subscription, pattern='^stop_subscription'),
                CallbackQueryHandler(open_menu, pattern='^open_menu$')
            ],
            OPEN_TASKS: [
                CallbackQueryHandler(show_open_task, pattern='^open_task$'),
                CallbackQueryHandler(send_task_to_friend, pattern='^send_task$'),
                CallbackQueryHandler(open_menu, pattern='^open_menu$')
            ],
            NO_CATEGORY: [
                CallbackQueryHandler(email_feedback, pattern='^add_new_category$'),
                CallbackQueryHandler(show_open_task, pattern='^open_task$'),
                CallbackQueryHandler(open_menu, pattern='^open_menu$')
            ],
            AFTER_ADD_CATEGORY: [
                CallbackQueryHandler(open_menu, pattern='^open_menu$')
            ],
            AFTER_NEW_QUESTION: [
                CallbackQueryHandler(email_feedback, pattern='^open_menu$')
            ],
            AFTER_ADD_FEATURE: [
                CallbackQueryHandler(email_feedback, pattern='^open_menu$')
            ],
            CANCEL_FEEDBACK: [
                CallbackQueryHandler(cancel_feedback, pattern='^many_notification$'),
                CallbackQueryHandler(cancel_feedback, pattern='^no_time$'),
                CallbackQueryHandler(cancel_feedback, pattern='^no_relevant_task$'),
                CallbackQueryHandler(cancel_feedback, pattern='^bot_is_bad$'),
                CallbackQueryHandler(cancel_feedback, pattern='^fond_ignore'),
                CallbackQueryHandler(cancel_feedback, pattern='^another')
            ]
        },

        fallbacks=[CommandHandler('cancel', cancel)]
    )
    update_users_category = CallbackQueryHandler(change_user_categories, pattern='^up_cat[0-9]{1,2}$')

    dispatcher.add_handler(conv_handler)
    dispatcher.add_handler(update_users_category)
    updater.start_polling()
